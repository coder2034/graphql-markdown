import path from "path";
import { promises as fs } from "fs";

import prettier from "prettier";

const SIDEBAR_FILE = "sidebar-schema.js";

const prettifyJavascript = (content) => {
  const data = prettier.format(content, { parser: "babel" });
  return JSON.stringify(data, null, 2);
};

const prettifyMarkdown = (content) => {
  return prettier.format(content, { parser: "markdown" });
};

const renderHomepage = async (homepageLocation, { outputDir }) => {
  const homepage = await fs.readFile(homepageLocation, "utf8");

  const filePath = path.join(outputDir, path.basename(homepageLocation));
  await fs.writeFile(filePath, prettifyMarkdown(homepage), "utf8");

  return path.relative("./", filePath);
};

const renderSidebar = async ({ outputDir, baseURL }) => {
  const sidebar = {
    schemaSidebar: [
      {
        type: "autogenerated",
        dirName: baseURL,
      },
    ],
  }

  const filePath = path.join(outputDir, SIDEBAR_FILE);
  await fs.writeFile(filePath, prettifyJavascript(sidebar), "utf8");

  return path.relative("./", filePath);
};

const generateDocFromSchema = async (schema, options) => {
  let pages = [];

  await renderHomepage(options.homepage, options);
  const sidebarPath = await renderSidebar(options);

  return { pages: pages.length, sidebar: sidebarPath };
};

module.exports = { generateDocFromSchema };
